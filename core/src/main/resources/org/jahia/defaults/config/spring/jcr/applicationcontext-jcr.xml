<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
                        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd">

    <bean id="validatorFactoryBean" class="org.springframework.validation.beanvalidation.LocalValidatorFactoryBean">
        <property name="messageInterpolator">
            <bean class="org.jahia.services.content.decorator.validation.JahiaMessageInterpolator"/>
        </property>
    </bean>

    <bean name="nodeTypesDBService" class="org.jahia.services.content.nodetypes.NodeTypesDBServiceImpl">
        <property name="hibernateSessionFactory" ref="sessionFactory"/>
    </bean>

    <bean id="nodeTypeRegistry" class="org.jahia.services.content.nodetypes.NodeTypeRegistry"
          factory-method="getInstance"/>

    <bean id="AbstractJCRStoreProvider" class="org.jahia.services.content.JCRStoreProvider" abstract="true"
          init-method="start" destroy-method="stop">
        <property name="userManagerService" ref="JahiaUserManagerService"/>
        <property name="groupManagerService" ref="JahiaGroupManagerService"/>
        <property name="sitesService" ref="JahiaSitesService"/>
        <property name="service" ref="JCRStoreService"/>
        <property name="sessionFactory" ref="jcrSessionFactory"/>
    </bean>

    <bean id="AbstractJCRStoreProviderPrototype" class="org.jahia.services.content.JCRStoreProvider" abstract="true"
          destroy-method="stop" scope="prototype">
        <property name="userManagerService" ref="JahiaUserManagerService"/>
        <property name="groupManagerService" ref="JahiaGroupManagerService"/>
        <property name="sitesService" ref="JahiaSitesService"/>
        <property name="service" ref="JCRStoreService"/>
        <property name="sessionFactory" ref="jcrSessionFactory"/>
    </bean>

    <bean id="DefaulJCRStoreProvider" class="org.jahia.services.content.impl.jackrabbit.JackrabbitStoreProvider"
          parent="AbstractJCRStoreProvider">
        <property name="key" value="default"/>
        <property name="repository" ref="jackrabbit"/>
        <property name="mountPoint" value="/"/>
        <property name="webdavPath" value="/repository"/>
        <property name="patcher" ref="patcher"/>
        <!--
        <property name="rmibind" value="jackrabbit"/>
        -->
        <property name="providesDynamicMountPoints" value="true"/>
    </bean>

    <bean id="jcrSessionFactory" class="org.jahia.services.content.JCRSessionFactory" factory-method="getInstance"
          lazy-init="true" init-method="start" depends-on="JahiaSAXParserFactory">
        <property name="userService" ref="JahiaUserManagerService"/>
        <property name="validatorFactoryBean" ref="validatorFactoryBean"/>
        <property name="descriptors">
            <map>
                <entry key="jcr.specification.version" value="1.0"/>
                <entry key="jcr.specification.name"
                       value="Content Repository API for Java(TM) Technology Specification"/>
                <entry key="jcr.repository.vendor" value="${jahia.jcr.repository.vendor:Jahia}"/>
                <entry key="jcr.repository.vendor.url" value="${jahia.jcr.repository.vendor.url:}"/>
                <entry key="jcr.repository.name" value="${jahia.jcr.repository.name:Content repository}"/>
                <entry key="jcr.repository.version" value="${jahia.jcr.repository.version:1.0}"/>
                <entry key="level.1.supported" value="true"/>
                <entry key="level.2.supported" value="true"/>
                <entry key="option.transactions.supported" value="true"/>
                <entry key="option.versioning.supported" value="true"/>
                <entry key="option.observation.supported" value="false"/>
                <entry key="option.locking.supported" value="true"/>
                <entry key="option.query.sql.supported" value="true"/>
                <entry key="query.xpath.pos.index" value="true"/>
                <entry key="query.xpath.doc.order" value="false"/>
                <entry key="org.apache.jackrabbit.spi.commons.AdditionalEventInfo" value="true"/>
            </map>
        </property>
        <property name="servletContextAttributeName" value="uch"/>
    </bean>

    <bean id="jcrTemplate" class="org.jahia.services.content.JCRTemplate" factory-method="getInstance">
        <property name="sessionFactory" ref="jcrSessionFactory"/>
    </bean>

    <bean id="urlResolverListener" class="org.jahia.services.render.URLResolverListener">
        <property name="availableDuringPublish" value="true"/>
    </bean>

    <bean id="BaseRulesListener" class="org.jahia.services.content.rules.RulesListener" init-method="start"
          abstract="true">
        <property name="globalObjects">
            <map>
                <entry key="service"
                       value-ref="org.jahia.services.content.rules.Service"/>
                <entry key="imageService"
                       value-ref="org.jahia.services.content.rules.ImageService"/>
                <entry key="extractionService"
                       value-ref="org.jahia.services.content.rules.ExtractionService"/>
                <entry key="notificationService"
                       value-ref="org.jahia.services.content.rules.RulesNotificationService"/>
                <entry key="sitePubSubService"
                       value-ref="sitePublisherSubscriber"/>
            </map>
        </property>
        <property name="disabledRules" value="${jahia.rules.disabledConfig:}"/>
    </bean>

    <bean id="JCRStoreService" class="org.jahia.services.content.JCRStoreService" parent="jahiaServiceTemplate"
          factory-method="getInstance" lazy-init="true" depends-on="springContextSingleton,nodeTypeRegistry">
        <property name="sessionFactory" ref="jcrSessionFactory"/>
        <property name="nodeTypesDBService" ref="nodeTypesDBService"/>
        <property name="decorators">
            <map>
                <!--AVOID putting mixin in this sets, only primary node type are allowed for decorators-->
                <entry key="jnt:virtualsite" value="org.jahia.services.content.decorator.JCRSiteNode"/>
                <entry key="nt:file" value="org.jahia.services.content.decorator.JCRFileNode"/>
                <entry key="nt:folder" value="org.jahia.services.content.decorator.JCRFileNode"/>
                <entry key="nt:query" value="org.jahia.services.content.decorator.JCRQueryNode"/>
                <entry key="jnt:mountPoint" value="org.jahia.services.content.decorator.JCRMountPointNode"/>
                <entry key="jnt:layout" value="org.jahia.services.content.decorator.JCRLayoutNode"/>
                <entry key="nt:version" value="org.jahia.services.content.decorator.JCRVersion"/>
                <entry key="nt:versionHistory" value="org.jahia.services.content.decorator.JCRVersionHistory"/>
                <entry key="nt:frozenNode" value="org.jahia.services.content.decorator.JCRFrozenNode"/>
                <entry key="jnt:fileReference" value="org.jahia.services.content.decorator.JCRReferenceNode"/>
                <entry key="jnt:imageReference" value="org.jahia.services.content.decorator.JCRReferenceNode"/>
                <entry key="jnt:contentReference" value="org.jahia.services.content.decorator.JCRReferenceNode"/>
                <entry key="jnt:contentFolderReference" value="org.jahia.services.content.decorator.JCRReferenceNode"/>
                <entry key="jnt:nodeLink" value="org.jahia.services.content.decorator.JCRReferenceNode"/>
                <entry key="jnt:simplePreference"
                       value="org.jahia.services.preferences.generic.GenericJahiaPreference"/>
                <entry key="jnt:pagePreference" value="org.jahia.services.preferences.page.PageJahiaPreference"/>
                <entry key="jnt:user" value="org.jahia.services.content.decorator.JCRUserNode"/>
                <entry key="jnt:group" value="org.jahia.services.content.decorator.JCRGroupNode"/>
                <entry key="jnt:component" value="org.jahia.services.content.decorator.JCRComponentNode"/>
                <entry key="jnt:componentFolder" value="org.jahia.services.content.decorator.JCRComponentNode"/>
                <entry key="jnt:passwordHistoryEntry"
                       value="org.jahia.services.content.decorator.JCRPasswordHistoryEntryNode"/>
            </map>
        </property>
        <property name="noValidityCheckTypes">
            <set>
                <value>jnt:acl</value>
                <value>jnt:componentFolder</value>
                <value>jnt:contentFolder</value>
                <value>jnt:groupsFolder</value>
                <value>jnt:pageTemplate</value>
                <value>jnt:tagList</value>
                <value>jnt:template</value>
                <value>jnt:templatesFolder</value>
                <value>jnt:vanityUrl</value>
                <value>jnt:vanityUrls</value>
                <value>jnt:virtualsite</value>
                <value>jnt:virtualsitesFolder</value>
                <value>rep:root</value>
            </set>
        </property>
        <property name="noLanguageValidityCheckTypes">
            <set>
                <value>jnt:file</value>
            </set>
        </property>
        <property name="listeners">
            <map>
                <entry key="default">
                    <list>
                        <bean class="org.jahia.services.content.DefaultValueListener"/>
                        <bean class="org.jahia.services.content.NodenameListener"/>
                        <bean class="org.jahia.services.content.AclListener">
                            <property name="userService" ref="JahiaUserManagerService"/>
                            <property name="groupService" ref="JahiaGroupManagerService"/>
                            <property name="publicationService" ref="jcrPublicationService"/>
                        </bean>
                        <bean class="org.jahia.services.content.LastModifiedListener">
                            <property name="publicationService" ref="jcrPublicationService"/>
                        </bean>
                        <bean class="org.apache.jackrabbit.core.security.PrivilegesListener"/>
                        <bean class="org.jahia.services.content.rules.RulesListener" parent="BaseRulesListener">
                            <property name="name" value="JCR Rules listener (Default)"/>
                            <property name="ruleFiles">
                                <set>
                                    <value>/repository/rules/repository-rules.drl</value>
                                    <value>/repository/rules/text-extraction-rules.drl</value>
                                </set>
                            </property>

                            <property name="filesAccepted">
                                <list value-type="java.lang.String">
                                    <value type="java.lang.String">rules.drl</value>
                                    <value type="java.lang.String">default-rules.drl</value>
                                </list>
                            </property>
                            <property name="operationTypes">
                                <set value-type="java.lang.Integer">
                                    <value type="java.lang.Integer">1</value>
                                    <value type="java.lang.Integer">13</value>
                                </set>
                            </property>
                        </bean>
                        <bean class="org.jahia.services.content.textextraction.TextExtractionListener">
                            <property name="extractionService"
                                      ref="org.jahia.services.content.rules.ExtractionService"/>
                            <property name="schedulerService" ref="SchedulerService"/>
                        </bean>
                        <bean class="org.jahia.services.content.files.FileCacheListener">
                            <property name="moduleCacheProvider" ref="ModuleCacheProvider"/>
                            <property name="cacheManager" ref="FileCacheManager"/>
                        </bean>
                        <bean class="org.jahia.services.logging.MetricsLoggingJCReventListener">
                            <property name="loggingService" ref="loggingService"/>
                            <property name="nodeTypesList">
                                <list/>
                            </property>
                            <property name="availableDuringPublish" value="true"/>
                        </bean>
                        <bean class="org.jahia.services.render.filter.cache.RenderServiceTemplateCacheEventListener">
                        </bean>
                        <ref bean="urlResolverListener"/>
                        <bean class="org.jahia.services.history.NodeVersionHistoryListener">
                            <property name="schedulerService" ref="SchedulerService"/>
                        </bean>
                        <bean class="org.jahia.services.mail.MailSettingsListener"/>
                        <bean class="org.jahia.services.search.SearchSettingsListener"/>
                        <bean class="org.jahia.services.content.PageModelListener"/>
                        <ref bean="mountPointListener"/>
                        <!--
                        <ref bean="NodeOperationEventListener" />
                        -->
                    </list>
                </entry>
                <entry key="live">
                    <list>
                        <bean class="org.jahia.services.content.UnpublishOnLiveDeletionListener"/>
                        <bean class="org.jahia.services.content.DefaultValueListener"/>
                        <bean class="org.jahia.services.content.UGCListener">
                            <property name="excludePropertiesFromUGCCheck"
                                      value="${jahia.ugc.excludePropertiesFromUGCCheck:j:published}"/>
                        </bean>
                        <bean class="org.jahia.services.content.NodenameListener">
                            <property name="availableDuringPublish" value="true"/>
                        </bean>
                        <bean class="org.jahia.services.content.AclListener">
                            <property name="availableDuringPublish" value="true"/>
                            <property name="userService" ref="JahiaUserManagerService"/>
                            <property name="groupService" ref="JahiaGroupManagerService"/>
                            <property name="publicationService" ref="jcrPublicationService"/>
                        </bean>
                        <bean class="org.jahia.services.content.LastModifiedListener">
                            <property name="publicationService" ref="jcrPublicationService"/>
                        </bean>
                        <bean class="org.jahia.services.content.rules.RulesListener" parent="BaseRulesListener">
                            <property name="name" value="JCR Rules listener (Live)"/>
                            <property name="ruleFiles" value="/repository/rules/repository-live-rules.drl"/>
                            <property name="filesAccepted">
                                <list value-type="java.lang.String">
                                    <value type="java.lang.String">rules.drl</value>
                                </list>
                            </property>
                            <property name="operationTypes">
                                <set value-type="java.lang.Integer">
                                    <value type="java.lang.Integer">1</value>
                                    <value type="java.lang.Integer">13</value>
                                </set>
                            </property>
                        </bean>
                        <bean class="org.jahia.services.content.rules.RulesListener" parent="BaseRulesListener">
                            <property name="name" value="JCR Rules listener (Live and publication)"/>
                            <property name="ruleFiles">
                                <set/>
                            </property>

                            <property name="filesAccepted">
                                <list value-type="java.lang.String">
                                    <value type="java.lang.String">live-rules.drl</value>
                                </list>
                            </property>
                            <property name="availableDuringPublish" value="true"/>
                            <property name="operationTypes">
                                <set value-type="java.lang.Integer">
                                    <value type="java.lang.Integer">1</value>
                                    <value type="java.lang.Integer">13</value>
                                    <value type="java.lang.Integer">4</value>
                                </set>
                            </property>
                        </bean>
                        <bean class="org.jahia.services.content.textextraction.TextExtractionListener">
                            <property name="extractionService"
                                      ref="org.jahia.services.content.rules.ExtractionService"/>
                            <property name="schedulerService" ref="SchedulerService"/>
                        </bean>
                        <bean class="org.jahia.services.content.files.FileCacheListener">
                            <property name="moduleCacheProvider" ref="ModuleCacheProvider"/>
                            <property name="cacheManager" ref="FileCacheManager"/>
                            <property name="availableDuringPublish" value="true"/>
                        </bean>
                        <ref bean="htmlCacheEventListener"/>
                        <bean class="org.jahia.services.render.filter.cache.RenderServiceTemplateCacheEventListener">
                            <property name="availableDuringPublish" value="true"/>
                        </bean>
                        <ref bean="org.jahia.services.templates.JCRModuleListener"/>
                        <ref bean="urlResolverListener"/>
                        <bean class="org.jahia.services.history.NodeVersionHistoryListener">
                            <property name="schedulerService" ref="SchedulerService"/>
                        </bean>
                    </list>
                </entry>
            </map>
        </property>
        <property name="interceptors">
            <list>
                <bean class="org.jahia.services.content.interceptor.TemplateModuleInterceptor">
                    <property name="requiredTypes">
                        <list>
                            <value>Reference</value>
                            <value>WeakReference</value>
                        </list>
                    </property>
                </bean>
                <bean class="org.jahia.services.content.ChangedNodeInterceptor"/>
                <bean class="org.jahia.services.content.interceptor.LastModifiedInterceptor"/>
                <bean class="org.jahia.services.content.interceptor.HtmlFilteringInterceptor"
                      parent="abstractRichTextPropertyInterceptor">
                    <property name="considerSiteSettingsForFiltering" value="true"/>
                    <!-- if removeContentBetweenTags is set to true also the content between the filtered tags will be removed -->
                    <property name="removeContentBetweenTags" value="false"/>
                </bean>
                <ref bean="urlInterceptor"/>
                <bean class="org.jahia.services.content.interceptor.TagInterceptor">
                    <property name="taggingService" ref="org.jahia.services.tags.TaggingService"/>
                    <property name="nodeTypes">
                        <list>
                            <value>jmix:tagged</value>
                        </list>
                    </property>
                    <property name="propertyNames">
                        <list>
                            <value>j:tagList</value>
                        </list>
                    </property>
                </bean>
            </list>
        </property>
        <property name="providerChecker" ref="JCRStoreProviderChecker"/>
    </bean>

    <bean id="baseURLTagReplacer" class="org.jahia.services.content.interceptor.url.BaseURLReplacer">
        <property name="urlInterceptor" ref="urlInterceptor"/>
    </bean>

    <bean id="srcSetReplacer" class="org.jahia.services.content.interceptor.url.SrcSetURLReplacer">
        <property name="urlInterceptor" ref="urlInterceptor"/>
    </bean>

    <bean id="urlInterceptor" class="org.jahia.services.content.interceptor.URLInterceptor"
          parent="abstractRichTextPropertyInterceptor">
        <constructor-arg ref="org.jahia.services.render.filter.URLTraverser"/>
        <property name="urlReplacers">
            <list>
                <ref bean="srcSetReplacer"/>
                <ref bean="baseURLTagReplacer"/>
            </list>
        </property>
    </bean>

    <bean id="mountPointListener" class="org.jahia.services.content.MountPointListener">
        <property name="schedulerService" ref="SchedulerService"/>
        <property name="providerChecker" ref="JCRStoreProviderChecker"/>
        <property name="cacheProvider" ref="ModuleCacheProvider"/>
    </bean>

    <bean id="htmlCacheEventListener" class="org.jahia.services.render.filter.cache.HtmlCacheEventListener">
        <property name="schedulerService" ref="SchedulerService"/>
        <property name="cacheProvider" ref="ModuleCacheProvider"/>
        <property name="availableDuringPublish" value="true"/>
        <property name="operationTypes">
            <set value-type="java.lang.Integer">
                <value type="java.lang.Integer">1</value>
                <value type="java.lang.Integer">4</value>
                <value type="java.lang.Integer">12</value>
                <value type="java.lang.Integer">13</value>
                <value type="java.lang.Integer">14</value>
            </set>
        </property>
    </bean>

    <bean id="abstractRichTextPropertyInterceptor" class="org.jahia.services.content.interceptor.BaseInterceptor"
          abstract="true">
        <property name="requiredTypes" value="String"/>
        <property name="selectors" value="RichText"/>
    </bean>

    <bean id="propertyInterceptorRegistrator"
          class="org.jahia.services.content.interceptor.PropertyInterceptorRegistrator" abstract="true">
        <property name="jcrStoreService" ref="JCRStoreService"/>
    </bean>

    <bean id="org.jahia.services.templates.JCRModuleListener" class="org.jahia.services.templates.JCRModuleListener">
        <property name="packageRegistry" ref="org.jahia.services.templates.TemplatePackageRegistry"/>
    </bean>

    <bean id="jcrVersionService" class="org.jahia.services.content.JCRVersionService" factory-method="getInstance">
        <property name="versionedTypes" value="${jahia.publication.versionedTypes:}"/>
        <property name="excludedVersionedTypes" value="${jahia.publication.excludedVersionedTypes:}"/>
    </bean>

    <bean id="jcrPublicationService" class="org.jahia.services.content.JCRPublicationService"
          factory-method="getInstance" depends-on="loggingService">
        <property name="sessionFactory" ref="jcrSessionFactory"/>
        <property name="loggingService" ref="loggingService"/>
        <property name="propertiesToSkipForReferences"
                  value="${jahia.publicationStatus.propertiesToSkipForReferencesInternal:*,j:defaultCategory,j:sourceTemplate,j:tags,j:templateNode},${jahia.publicationStatus.propertiesToSkipForReferences:}"/>
        <property name="referencedNodeTypesToSkip"
                  value="${jahia.publicationStatus.referencedNodeTypesToSkipInternal:jnt:page,jmix:autoPublish},${jahia.publicationStatus.referencedNodeTypesToSkip:}"/>
        <property name="versionedTypes" value="${jahia.publication.versionedTypes:}"/>
        <property name="excludedVersionedTypes" value="${jahia.publication.excludedVersionedTypes:}"/>
        <property name="batchSize" value="${jahia.publication.batchSize:100}"/>
    </bean>

    <bean id="jackrabbit" class="org.jahia.services.content.impl.jackrabbit.SpringJackrabbitRepository"
          factory-method="getInstance"
          init-method="start" destroy-method="stop" depends-on="JahiaTemplateManagerService,dataSource">
        <property name="configFile" value="WEB-INF/etc/repository/jackrabbit/repository.xml"/>
        <property name="servletContextAttributeName"
                  value="org.jahia.services.content.impl.jackrabbit.SpringJackrabbitRepository"/>
        <!-- the ID of the Spring bean with the definition of a background job for DataStore garbage collection -->
        <property name="dataStoreGarbageCollectorBeanId" value="DataStoreGarbageCollectorJob"/>
        <property name="settings" ref="settingsBean"/>
        <property name="performMigrationToDataStoreIfNeeded"
                  value="${jahia.jackrabbit.performMigrationToDataStoreIfNeeded:true}"/>
        <property name="timeoutSwitchingToReadOnlyMode"
                  value="${jahia.jackrabbit.cluster.timeoutSwitchingToReadOnly:60000}"/>
    </bean>

    <bean id="rbInitializer"
          class="org.jahia.services.content.nodetypes.initializers.ResourceBundleChoiceListInitializerImpl"/>
    <bean id="countryInitializerRenderer"
          class="org.jahia.services.content.nodetypes.initializers.CountryChoiceListInitializerAndRendererImpl"/>
    <bean id="countryFlagInitializer"
          class="org.jahia.services.content.nodetypes.initializers.CountryFlagChoiceListInitializerAndRendererImpl"/>
    <bean id="templatesInitializer"
          class="org.jahia.services.content.nodetypes.initializers.TemplatesChoiceListInitializerImpl"/>
    <bean id="templatesNodeInitializer"
          class="org.jahia.services.content.nodetypes.initializers.TemplatesNodeChoiceListInitializer"/>
    <bean id="renderModesInitializer"
          class="org.jahia.services.content.nodetypes.initializers.RenderModesChoiceListInitializer"/>
    <bean id="usersInitializer"
          class="org.jahia.services.content.nodetypes.initializers.UsersChoiceListInitializerImpl"/>
    <bean id="moduleImageInitializer"
          class="org.jahia.services.content.nodetypes.initializers.ModuleImageChoiceListInitializerImpl"/>
    <bean id="nodetypesInitializer"
          class="org.jahia.services.content.nodetypes.initializers.NodeTypesChoiceListInitializerImpl"/>
    <bean id="subNodetypesInitializer"
          class="org.jahia.services.content.nodetypes.initializers.SubNodeTypesChoiceListInitializerImpl"/>
    <bean id="nodesInitializer"
          class="org.jahia.services.content.nodetypes.initializers.NodesChoiceListInitializerImpl">
        <property name="sessionFactory" ref="jcrSessionFactory"/>
    </bean>
    <bean id="menuInitializer"
          class="org.jahia.services.content.nodetypes.initializers.MenusChoiceListInitializerImpl">
    </bean>
    <bean id="permissionsInitializer"
          class="org.jahia.services.content.nodetypes.initializers.PermissionsChoiceListInitializer">
    </bean>
    <bean id="scriptInitializer"
          class="org.jahia.services.content.nodetypes.initializers.ScriptChoiceListInitializerImpl">
        <property name="scriptEngineUtils" ref="scriptEngineUtils"/>
    </bean>
    <bean id="sortableFieldnamesInitializer"
          class="org.jahia.services.content.nodetypes.initializers.SortableFieldnamesChoiceListInitializerImpl">
        <property name="excludedNodeTypes">
            <set>
                <value type="java.lang.String">jmix:nodenameInfo</value>
                <value type="java.lang.String">mix:referenceable</value>
                <value type="java.lang.String">mix:simpleVersionable</value>
                <value type="java.lang.String">mix:versionable</value>
                <value type="java.lang.String">nt:base</value>
                <value type="java.lang.String">jnt:acl</value>
                <value type="java.lang.String">jnt:translation</value>
            </set>
        </property>
        <property name="showHidden" value="false"/>
        <property name="showProtected" value="true"/>
    </bean>
    <bean id="commponentLinkerInitializer"
          class="org.jahia.services.content.nodetypes.initializers.ComponentLinkerChoiceListInitializer"/>
    <bean id="workflowInitializer"
          class="org.jahia.services.content.nodetypes.initializers.WorkflowChoiceListInitializer">
        <property name="workflowService" ref="workflowService"/>
    </bean>
    <bean id="workflowTypesInitializer"
          class="org.jahia.services.content.nodetypes.initializers.WorkflowTypesChoiceListInitializer">
        <property name="workflowService" ref="workflowService"/>
    </bean>
    <bean id="sortInitializer"
          class="org.jahia.services.content.nodetypes.initializers.SortChoiceListInitializerImpl"/>
    <bean id="nodeReferenceRenderer"
          class="org.jahia.services.content.nodetypes.renderer.NodeReferenceChoiceListRenderer"/>
    <bean id="componentTypesInitializer"
          class="org.jahia.services.content.nodetypes.initializers.ComponentTypesChoiceListInitializerImpl"/>
    <bean id="channelInitializer" class="org.jahia.services.channels.ChannelChoiceListInitializer">
        <property name="channelService" ref="ChannelService"/>
    </bean>
    <bean id="propertyValuesChoiceListInitializer"
          class="org.jahia.services.content.nodetypes.initializers.PropertyValuesChoiceListInitializer"/>
    <bean id="namespaceChoiceListInitializer"
          class="org.jahia.services.content.nodetypes.initializers.NamespaceChoiceListInitializer"/>
    <bean id="siteLanguageInitializer"
          class="org.jahia.services.content.nodetypes.initializers.SiteLanguagesChoiceListInitializerImpl"/>
    <bean id="choiceListInitializers"
          class="org.jahia.services.content.nodetypes.initializers.ChoiceListInitializerService"
          factory-method="getInstance">
        <property name="initializers">
            <map>
                <entry key="resourceBundle" value-ref="rbInitializer"/>
                <entry key="country" value-ref="countryInitializerRenderer"/>
                <entry key="templates" value-ref="templatesInitializer"/>
                <entry key="templatesNode" value-ref="templatesNodeInitializer"/>
                <entry key="renderModes" value-ref="renderModesInitializer"/>
                <entry key="users" value-ref="usersInitializer"/>
                <entry key="nodetypes" value-ref="nodetypesInitializer"/>
                <entry key="subnodetypes" value-ref="subNodetypesInitializer"/>
                <entry key="nodes" value-ref="nodesInitializer"/>
                <entry key="menus" value-ref="menuInitializer"/>
                <entry key="script" value-ref="scriptInitializer"/>
                <entry key="flag" value-ref="countryFlagInitializer"/>
                <entry key="sortableFieldnames" value-ref="sortableFieldnamesInitializer"/>
                <entry key="moduleImage" value-ref="moduleImageInitializer"/>
                <entry key="linkerProps" value-ref="commponentLinkerInitializer"/>
                <entry key="workflow" value-ref="workflowInitializer"/>
                <entry key="workflowTypes" value-ref="workflowTypesInitializer"/>
                <entry key="sort" value-ref="sortInitializer"/>
                <entry key="componenttypes" value-ref="componentTypesInitializer"/>
                <entry key="channels" value-ref="channelInitializer"/>
                <entry key="propertyValues" value-ref="propertyValuesChoiceListInitializer"/>
                <entry key="namespace" value-ref="namespaceChoiceListInitializer"/>
                <entry key="permissions" value-ref="permissionsInitializer"/>
                <entry key="siteLanguage" value-ref="siteLanguageInitializer"/>
            </map>
        </property>
    </bean>
    <bean id="choiceListRenderers" class="org.jahia.services.content.nodetypes.renderer.ChoiceListRendererService"
          factory-method="getInstance">
        <property name="renderers">
            <map>
                <entry key="country" value-ref="countryInitializerRenderer"/>
                <entry key="flagcountry" value-ref="countryFlagInitializer"/>
                <entry key="resourceBundle" value-ref="rbInitializer"/>
                <entry key="nodeReference" value-ref="nodeReferenceRenderer"/>
            </map>
        </property>
    </bean>

    <bean id="org.jahia.services.content.rules.ImageService" class="org.jahia.services.content.rules.ImageService"
          factory-method="getInstance">
        <property name="imageService" ref="imageService"/>
    </bean>

    <bean class="org.jahia.services.atmosphere.rules.SitePublisherSubscriberRuleService">
        <property name="publisherSubscriberService" ref="sitePublisherSubscriber"/>
    </bean>

    <bean id="org.jahia.services.content.rules.Service" class="org.jahia.services.content.rules.Service"
          factory-method="getInstance">
        <property name="taggingService" ref="org.jahia.services.tags.TaggingService"/>
        <property name="cacheService" ref="JahiaCacheService"/>
        <property name="schedulerService" ref="SchedulerService"/>
        <property name="sitesService" ref="JahiaSitesService"/>
        <property name="groupManagerService" ref="JahiaGroupManagerService"/>
        <property name="userManagerService" ref="JahiaUserManagerService"/>
        <property name="passwordPolicyService" ref="JahiaPasswordPolicyService"/>
    </bean>

    <bean id="JcrSessionFilter" class="org.jahia.bin.filters.jcr.JcrSessionFilter">
        <property name="authPipeline" ref="authPipeline"/>
        <property name="bypassForPatterns">
            <util:list value-type="java.lang.String">
                <value>/server/*</value>
            </util:list>
        </property>
        <property name="sessionFactory" ref="jcrSessionFactory"/>
        <property name="userManagerService" ref="JahiaUserManagerService"/>
    </bean>

    <util:set id="DocumentViewImportHandler.propertiesToSkip">
        <value>jcr:uuid</value>
        <value>j:publicationStatus</value>
        <value>jcr:primaryType</value>
        <value>j:share</value>
        <value>j:originWS</value>
        <value>jcr:mixinTypes</value>
        <value>j:siteId</value>
        <value>j:lastPublished</value>
        <value>j:lastPublishedBy</value>
        <value>j:published</value>
        <value>jcr:created</value>
        <value>jcr:createdBy</value>
        <value>jcr:mimeType</value>
        <value>jcr:lockOwner</value>
        <value>jcr:lockIsDeep</value>
        <value>j:locktoken</value>
        <value>j:lockTypes</value>
        <value>j:processId</value>
        <value>j:staticMountPointProviderKey</value>
        <value>j:dynamicMountPointProviderPath</value>
    </util:set>

    <util:map id="ImportDefinitionsMappingMetadata">
        <entry key="jahia:defaultCategory">
            <bean class="org.jahia.services.importexport.DefinitionsMapping$PropertyMapping">
                <constructor-arg index="0" value="jahia:defaultCategory"/>
                <constructor-arg index="1" value="jmix:categorized|j:defaultCategory"/>
            </bean>
        </entry>
        <entry key="jahia:keywords">
            <bean class="org.jahia.services.importexport.DefinitionsMapping$PropertyMapping">
                <constructor-arg index="0" value="jahia:keywords"/>
                <constructor-arg index="1" value="jmix:keywords|j:keywords"/>
            </bean>
        </entry>
        <entry key="jahia:description">
            <bean class="org.jahia.services.importexport.DefinitionsMapping$PropertyMapping">
                <constructor-arg index="0" value="jahia:description"/>
                <constructor-arg index="1" value="jmix:description|jcr:description"/>
            </bean>
        </entry>
        <entry key="jahia:createdBy">
            <bean class="org.jahia.services.importexport.DefinitionsMapping$PropertyMapping">
                <constructor-arg index="0" value="jahia:createdBy"/>
                <constructor-arg index="1" value="mix:created|jcr:createdBy"/>
            </bean>
        </entry>
        <entry key="jahia:lastModifiedBy">
            <bean class="org.jahia.services.importexport.DefinitionsMapping$PropertyMapping">
                <constructor-arg index="0" value="jahia:lastModifiedBy"/>
                <constructor-arg index="1" value="mix:lastModified|jcr:lastModifiedBy"/>
            </bean>
        </entry>
        <entry key="jahia:lastPublishingDate">
            <bean class="org.jahia.services.importexport.DefinitionsMapping$PropertyMapping">
                <constructor-arg index="0" value="jahia:lastPublishingDate"/>
                <constructor-arg index="1" value="jmix:lastPublished|j:lastPublished"/>
            </bean>
        </entry>
        <entry key="jahia:lastPublisher">
            <bean class="org.jahia.services.importexport.DefinitionsMapping$PropertyMapping">
                <constructor-arg index="0" value="jahia:lastPublisher"/>
                <constructor-arg index="1" value="jmix:lastPublished|j:lastPublishedBy"/>
            </bean>
        </entry>
        <entry key="jahia:ruleSettings">
            <bean class="org.jahia.services.importexport.DefinitionsMapping$PropertyMapping">
                <constructor-arg index="0" value="jahia:ruleSettings"/>
                <constructor-arg index="1" value="jmix:conditionalVisibility|j:legacyRuleSettings"/>
            </bean>
        </entry>
    </util:map>

    <bean id="DocumentViewValidationHandler"
          class="org.jahia.services.importexport.validation.DocumentViewValidationHandler" scope="prototype">
        <property name="validators">
            <list>
                <bean class="org.jahia.services.importexport.validation.MissingModulesValidator">
                    <property name="templateManagerService" ref="JahiaTemplateManagerService"/>
                </bean>
                <bean class="org.jahia.services.importexport.validation.MissingTemplatesValidator">
                    <property name="templateManagerService" ref="JahiaTemplateManagerService"/>
                    <property name="renderService" ref="RenderService"/>
                </bean>
                <bean class="org.jahia.services.importexport.validation.MissingNodetypesValidator"/>
                <bean class="org.jahia.services.importexport.validation.ProviderAvailabilityValidator">
                    <property name="jcrSessionFactory" ref="jcrSessionFactory"/>
                </bean>
                <bean class="org.jahia.services.importexport.validation.ConstraintsValidator"/>
                <bean class="org.jahia.services.importexport.validation.UserValidator">
                    <property name="userManagerService" ref="JahiaUserManagerService"/>
                </bean>
            </list>
        </property>
    </bean>

    <bean id="JCRStoreProviderChecker" class="org.jahia.services.content.JCRStoreProviderChecker"/>

    <bean parent="jobSchedulingBean">
        <property name="jobDetail">
            <bean class="org.springframework.scheduling.quartz.JobDetailBean">
                <property name="name" value="JCRStoreProviderCheckerJob"/>
                <property name="jobClass"
                          value="org.jahia.services.content.JCRStoreProviderCheckerJob"/>
                <property name="group" value="Maintenance"/>
                <property name="description" value="Check providers"/>
                <property name="jobDataAsMap">
                    <map>
                        <entry key="JCRStoreProviderChecker" value-ref="JCRStoreProviderChecker"/>
                    </map>
                </property>
            </bean>
        </property>
        <property name="trigger">
            <bean class="org.quartz.CronTrigger">
                <property name="name" value="RemoteCheckerJobTrigger"/>
                <!-- execute every 10 seconds -->
                <property name="cronExpression" value="0/10 * * * * ?"/>
            </bean>
        </property>
        <property name="ramJob" value="true"/>
    </bean>
</beans>
